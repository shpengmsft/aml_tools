# Azure Role Assignment Optimization Tools

This folder contains Python scripts to help optimize Azure Role Assignments by identifying and removing redundant assignments. This is useful for overcoming the limit of 4000 role assignments per subscription.

## Prerequisites

Ensure you have the required Python packages installed:

```bash
pip install azure-identity azure-mgmt-authorization requests
```

You must be authenticated with Azure CLI or have environment variables set up for `DefaultAzureCredential`.

```bash
az login
```

## Scripts

### 1. `optimize_role_assignments.py`

This script identifies users who have a direct role assignment on a resource (or scope) but are also members of a group that has the same role assignment on the same scope or a parent scope.

**Features:**
*   Detects redundancies via direct group membership and nested group membership (transitive).
*   Checks for coverage on the same scope and parent scopes (Resource Group, Subscription).
*   Supports Dry Run mode (default).
*   Can export redundant assignments to a CSV file for review.

**Usage:**

*   **Dry Run (Default):** Lists redundant assignments in the console without deleting them.
    ```bash
    python optimize_role_assignments.py --subscription-id <SUBSCRIPTION_ID>
    ```

*   **Export to CSV:** Saves the list of redundant assignments to a CSV file.
    ```bash
    python optimize_role_assignments.py --output-csv redundant_roles.csv
    ```

*   **Execute Deletions:** Directly deletes the redundant assignments found.
    ```bash
    python optimize_role_assignments.py --execute
    ```

**Arguments:**
*   `--subscription-id`: The Azure Subscription ID. Defaults to `921496dc-987f-410f-bd57-426eb2611356`.
*   `--execute`: If provided, the script will perform the deletions. If omitted, it runs in dry-run mode.
*   `--output-csv`: Path to a CSV file to write the redundant assignments to.

---

### 2. `delete_role_assignments_from_csv.py`

This script reads a CSV file (generated by `optimize_role_assignments.py`) and deletes the role assignments listed in it. This allows for a manual review process before deletion.

**Note:** The script automatically detects the Subscription ID from the `Scope` column in the CSV file, so you do not need to provide it as an argument.

**Usage:**

*   **Dry Run (Default):** Lists what would be deleted based on the CSV.
    ```bash
    python delete_role_assignments_from_csv.py --input-csv redundant_roles.csv
    ```

*   **Execute Deletions:** Deletes the assignments listed in the CSV.
    ```bash
    python delete_role_assignments_from_csv.py --input-csv redundant_roles.csv --execute
    ```

**Arguments:**
*   `--input-csv`: (Required) Path to the input CSV file containing role assignments to delete.
*   `--execute`: If provided, the script will perform the deletions. If omitted, it runs in dry-run mode.

## Workflow Example

1.  **Analyze and Export:** Run the optimization script to find redundancies and save them to a file.
    ```bash
    python optimize_role_assignments.py --output-csv candidates.csv
    ```

2.  **Review:** Open `candidates.csv` in Excel or a text editor. Remove any rows for assignments you want to keep (i.e., do *not* want to delete).

3.  **Clean Up:** Run the deletion script using the reviewed CSV file.
    ```bash
    python delete_role_assignments_from_csv.py --input-csv candidates.csv --execute
    ```
